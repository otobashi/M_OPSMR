-- 
SELECT *
from   dbo.M_OPSMR_TB_OP_RATE
where  base_yyyymm = '201604'
and    gbu_code = 'CVT'
and    kpi_period_code = '201603'
AND    OPSMR_TYPE = 'STD'
AND    FACTORY_REGION1 = 'LGEKR'
;

insert into dbo.M_OPSMR_TB_OP_RATE

select MONTH_RN
,TARGET_CODE
,KPI_PERIOD_CODE
,YYYYMM
,YEAR
,MON
,FACTORY_REGION1
,GBU_CODE
,GBU_NAME
,DATE_CODE
,WIP_LINE_CODE
,WIP_LINE_DESC
,STANDARD_OPERATION_RATE
,PRODUCTION_QUANTITY
,PRODUCTION_CAPA
,PEAK_OFF_SEASON
,TOTAL_LINE_NUMBER
,SHIFT_LINE_NUMBER1
,SHIFT_LINE_NUMBER2
,LINE_COUNT_TOTAL
,LINE_COUNT_USE
,LINE_COUNT_IDLE
,TOTAL_OVERTIME
,TOTAL_HOLIDAY_WORK_TIME
,OVERTIME_PER_PERSON
,HOLIDAY_WORKTIME_PER_PERSON
,WORKER_NUMBER_TOTAL
,ACTUAL_OPERATION_RATE
,ACTUAL_PRODUCTION_CAPA
,DUMMY1
,DUMMY2
,DUMMY3
,DUMMY4
,DUMMY5
,OPSMR_TYPE
,BASE_YYYYMM
,SCENARIO_TYPE_CODE
from   dbo.M_OPSMR_TB_OP_RATE_LINE A
where  base_yyyymm = '201604'
AND    KPI_PERIOD_CODE > '201603'
UNION ALL
SELECT B.MONTH_RN
,B.TARGET_CODE
,B.KPI_PERIOD_CODE
,B.YYYYMM
,B.YEAR
,B.MON
,B.FACTORY_REGION1
,B.GBU_CODE
,B.GBU_NAME
,B.DATE_CODE
,B.WIP_LINE_CODE
,B.WIP_LINE_DESC
,B.STANDARD_OPERATION_RATE
,B.PRODUCTION_QUANTITY
,B.PRODUCTION_CAPA
,B.PEAK_OFF_SEASON
,B.TOTAL_LINE_NUMBER
,B.SHIFT_LINE_NUMBER1
,B.SHIFT_LINE_NUMBER2
,B.LINE_COUNT_TOTAL
,B.LINE_COUNT_USE
,B.LINE_COUNT_IDLE
,B.TOTAL_OVERTIME
,B.TOTAL_HOLIDAY_WORK_TIME
,B.OVERTIME_PER_PERSON
,B.HOLIDAY_WORKTIME_PER_PERSON
,B.WORKER_NUMBER_TOTAL
,B.ACTUAL_OPERATION_RATE
,A.ACTUAL_PRODUCTION_CAPA * (CASE WHEN A.PRODUCTION_CAPA = 0 THEN 0 ELSE B.PRODUCTION_CAPA / A.PRODUCTION_CAPA END) AS ACTUAL_PRODUCTION_CAPA
,B.DUMMY1
,B.DUMMY2
,B.DUMMY3
,B.DUMMY4
,B.DUMMY5
,'PROD'
,B.BASE_YYYYMM
,B.SCENARIO_TYPE_CODE
FROM   (
select MONTH_RN
,TARGET_CODE
,KPI_PERIOD_CODE
,YYYYMM
,YEAR
,MON
,FACTORY_REGION1
,CASE WHEN COL=1 THEN 'CVTC7' ELSE 'CVTC11' END AS GBU_CODE
,GBU_NAME
,DATE_CODE
,WIP_LINE_CODE
,WIP_LINE_DESC
,STANDARD_OPERATION_RATE
,PRODUCTION_QUANTITY
,PRODUCTION_CAPA
,PEAK_OFF_SEASON
,TOTAL_LINE_NUMBER
,SHIFT_LINE_NUMBER1
,SHIFT_LINE_NUMBER2
,LINE_COUNT_TOTAL
,LINE_COUNT_USE
,LINE_COUNT_IDLE
,TOTAL_OVERTIME
,TOTAL_HOLIDAY_WORK_TIME
,OVERTIME_PER_PERSON
,HOLIDAY_WORKTIME_PER_PERSON
,WORKER_NUMBER_TOTAL
,ACTUAL_OPERATION_RATE
,ACTUAL_PRODUCTION_CAPA
,DUMMY1
,DUMMY2
,DUMMY3
,DUMMY4
,DUMMY5
,OPSMR_TYPE
,BASE_YYYYMM
,SCENARIO_TYPE_CODE
from   dbo.M_OPSMR_TB_OP_RATE A
      ,(SELECT 1 AS COL UNION ALL SELECT 2) B
where  base_yyyymm = '201604'
AND    KPI_PERIOD_CODE > '201603'
AND    GBU_CODE = 'CVT'
AND    FACTORY_REGION1 = 'LGEKR'
AND    OPSMR_TYPE = 'PROD'
) A
,(
select MONTH_RN
,TARGET_CODE
,KPI_PERIOD_CODE
,YYYYMM
,YEAR
,MON
,FACTORY_REGION1
,GBU_CODE
,GBU_NAME
,DATE_CODE
,WIP_LINE_CODE
,WIP_LINE_DESC
,STANDARD_OPERATION_RATE
,PRODUCTION_QUANTITY
,PRODUCTION_CAPA
,PEAK_OFF_SEASON
,TOTAL_LINE_NUMBER
,SHIFT_LINE_NUMBER1
,SHIFT_LINE_NUMBER2
,LINE_COUNT_TOTAL
,LINE_COUNT_USE
,LINE_COUNT_IDLE
,TOTAL_OVERTIME
,TOTAL_HOLIDAY_WORK_TIME
,OVERTIME_PER_PERSON
,HOLIDAY_WORKTIME_PER_PERSON
,WORKER_NUMBER_TOTAL
,ACTUAL_OPERATION_RATE
,ACTUAL_PRODUCTION_CAPA
,DUMMY1
,DUMMY2
,DUMMY3
,DUMMY4
,DUMMY5
,OPSMR_TYPE
,BASE_YYYYMM
,SCENARIO_TYPE_CODE
from   dbo.M_OPSMR_TB_OP_RATE_LINE A
where  base_yyyymm = '201604'
AND    KPI_PERIOD_CODE > '201603'
) B
WHERE A.BASE_YYYYMM = B.BASE_YYYYMM
AND   A.GBU_CODE = B.GBU_CODE
AND   A.KPI_PERIOD_CODE =  B.KPI_PERIOD_CODE
AND   A.FACTORY_REGION1 = B.FACTORY_REGION1
;

DELETE
FROM   M_OPSMR_TB_OP_RATE
WHERE  GBU_CODE = 'CVT'
AND    FACTORY_REGION1 = 'LGEKR'